name: üöÄ Build ‚Üí YCR ‚Üí K8s Deploy
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: üê≥ Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: üõ†Ô∏è Install Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- --no-rc
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

    - name: üîß Install & Configure Yandex Cloud CLI
      run: |
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ YC CLI
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        
        # ‚úÖ Source PATH (–∫—Ä–∏—Ç–∏—á–Ω–æ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏!)
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
        source $HOME/yandex-cloud/path.bash.inc
        
        # ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ key.json (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞!)
        echo '${{ secrets.YC_SA_KEY }}' | jq . > key.json
        
        # ‚úÖ –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è)
        yc config set service-account-key key.json
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        
        # ‚úÖ –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        yc iam list-service-accounts

    - name: üîê Login YCR (—á–µ—Ä–µ–∑ YC CLI)
      run: |
        yc container registry configure-docker
            
    - name: üèóÔ∏è Build & Push
      uses: docker/build-push-action@v6
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/dio-app:latest
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/dio-app:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false
        sbom: false
        
    - name: ‚ò∏Ô∏è Deploy to Kubernetes
      if: github.ref == 'refs/heads/main'
      env:
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "$KUBE_CONFIG_DATA" | base64 -d > kubeconfig.yaml
        export KUBECONFIG=kubeconfig.yaml
        
        # ‚úÖ Apply —Å —Ñ–ª–∞–≥–∞–º–∏
        sed "s/\${YC_REGISTRY_ID}/${YC_REGISTRY_ID}/g" k8s/deployment.yaml | \
          kubectl apply -f - --validate=false --insecure-skip-tls-verify=true
        
        kubectl apply -f k8s/service.yaml --validate=false --insecure-skip-tls-verify=true
        
        # ‚úÖ set image –ë–ï–ó --validate
        kubectl set image deployment/dio-app dio-app=cr.yandex/$YC_REGISTRY_ID/dio-app:$IMAGE_TAG \
          --insecure-skip-tls-verify=true
        
        # ‚úÖ rollout status –ë–ï–ó --validate
        kubectl rollout status deployment/dio-app --timeout=180s --insecure-skip-tls-verify=true
        
        kubectl get pods -l app=dio-app --insecure-skip-tls-verify=true
        rm kubeconfig.yaml
