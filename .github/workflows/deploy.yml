name: üöÄ Build ‚Üí YCR ‚Üí K8s Deploy
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: üê≥ Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: üîê Login YCR
      uses: docker/login-action@v3
      with:
        registry: cr.yandex
        username: iam
        password: ${{ secrets.YC_IAM_TOKEN }}
        
    - name: üèóÔ∏è Build & Push
      uses: docker/build-push-action@v6
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/dio-app:latest
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/dio-app:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false
        sbom: false
        
    - name: ‚ò∏Ô∏è Deploy to Kubernetes
      if: github.ref == 'refs/heads/main'
      env:
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "$KUBE_CONFIG_DATA" | base64 -d > kubeconfig.yaml
        export KUBECONFIG=kubeconfig.yaml
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ –ø–æ–¥–ø–∞–ø–∫–∏ k8s/
        sed "s/\${YC_REGISTRY_ID}/${YC_REGISTRY_ID}/g" k8s/deployment.yaml | kubectl apply -f -
        kubectl apply -f k8s/service.yaml
        
        # –û–±–Ω–æ–≤–ª—è–µ–º image –∏ –¥–µ–ª–∞–µ–º rollout
        kubectl set image deployment/dio-app dio-app=cr.yandex/$YC_REGISTRY_ID/dio-app:$IMAGE_TAG
        kubectl rollout status deployment/dio-app --timeout=180s
        
        kubectl get pods -l app=dio-app
        rm kubeconfig.yaml
