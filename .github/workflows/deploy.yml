name: ðŸš€ Build â†’ YCR â†’ K8s Deploy
on:
  push:
    tags: ['*']

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ³ Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Install Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
    
    - name: Configure Yandex Cloud CLI
      run: |
        echo '${{ secrets.YC_SA_KEY }}' > key.json
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
    
    - name: Configure Docker for Yandex Container Registry
      run: |
        yc container registry configure-docker
        
    - name: ðŸ—ï¸ Build & Push
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: |
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/dio-app:${{ github.ref_name }}
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/dio-app:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false
        sbom: false
        
    - name: â˜¸ï¸ Deploy to Kubernetes
      env:
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        IMAGE_TAG: ${{ github.ref_name }}
      run: |
        echo "$KUBE_CONFIG_DATA" | base64 -d > kubeconfig.yaml
        export KUBECONFIG=kubeconfig.yaml
        
        sed "s/\${YC_REGISTRY_ID}/${YC_REGISTRY_ID}/g; s/\${IMAGE_TAG}/${IMAGE_TAG}/g" k8s/deployment.yaml | \
          kubectl apply -f - --validate=false --insecure-skip-tls-verify=true
        
        kubectl apply -f k8s/service.yaml --validate=false --insecure-skip-tls-verify=true
        
        kubectl set image deployment/dio-app dio-app=cr.yandex/$YC_REGISTRY_ID/dio-app:$IMAGE_TAG \
          --insecure-skip-tls-verify=true
        
        kubectl rollout status deployment/dio-app --timeout=180s --insecure-skip-tls-verify=true
        
        kubectl get pods -l app=dio-app --insecure-skip-tls-verify=true
        rm kubeconfig.yaml
